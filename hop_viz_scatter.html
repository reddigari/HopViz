<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>TITLE</title>
    <meta name="description" content="DESCRIPTION">
    <link rel="stylesheet" href="PATH">
    <script src="d3/d3.min.js"></script>
    <!--[if lt IE 9]>
       <script src = "http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
     <![endif]-->
    <style>
        /*.svg-container {
            display: inline-block;
            position: relative;
            width: 100%;
            padding-bottom: 100%;
            vertical-align: top;
            overflow: hidden;
        }*/

        /*.svg-content-responsive {
            display: inline-block;
            position: absolute;
            top: 10px;
            left: 0;
        }*/

        body {
            font-family: sans-serif;
        }

        /*.aromaData .dataPoint,*/
        .aromaData .meanBar {
            stroke: blue;
            fill: white;
        }

        /*.flavorData .dataPoint,*/
        .flavorData .meanBar {
            stroke: red;
            fill: white;
        }
        div.tooltip {
          position: absolute;
          text-align: center;
          vertical-align: middle;
          width: 30px;
          height: auto;
          padding: 2px;
          font: 12px sans-serif;
          color: white;
          background: black;
          border: 0px;
          border-radius: 8px;
          pointer-events: none;
        }
    </style>
</head>

<body>
  <div id="chartId"></div>
    <script>
        var margin = {
                top: 50,
                right: 20,
                bottom: 20,
                left: 120
            },
            width = 850 - margin.left - margin.right,
            height = 500 - margin.top - margin.bottom;

        var rowHeight = 150,
            rowBuffer = 15;

        var dims = ['CITRUS', 'TROPICAL FRUIT', 'STONE FRUIT', 'APPLE-PEAR',
            'MELON', 'BERRY', 'FLORAL', 'SPICY-HERBAL', 'PINE', 'RESINOUS',
            'GRASSY', 'EARTHY-WOODY', 'ONION-GARLIC', 'DANK-CATTY'
        ];

        var senses = ["aroma", "flavor"];

        var xDim = d3.scaleBand()
            .domain(dims)
            .rangeRound([0, width])
            .paddingInner(0.15);

        var xSense = d3.scaleBand()
            .domain(senses)
            .rangeRound([0, xDim.bandwidth()])
            .paddingOuter(0.4);

        var dataRadius = xSense.bandwidth() / 5,
            barWidth = dataRadius * 3
            barHeight = 4;

        var y = d3.scaleLinear()
            .domain([0, 9])
            .range([rowHeight - rowBuffer, rowBuffer]);

        var yAxis = d3.axisLeft(y)
            .ticks(3)
            .tickSizeOuter(0);

        // d3.select("#chartId")
        //     .append("div")
        //     .classed("svg-container", true) //container class to make it responsive
        //     .append("svg")
        //     //responsive SVG needs these 2 attributes and no width and height attr
        //     .attr("preserveAspectRatio", "xMinYMin meet")
        //     .attr("viewBox", "0 0 600 400")
        //     //class to make it responsive
        //     .classed("svg-content-responsive", true);

        var g = d3.select("#chartId").append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        g.selectAll(".dimLabel")
            .data(dims)
            .enter()
            .append("text")
            .attr("x", function(d) { return xDim(d); })
            .attr("y", -margin.top/2)
            .text(function(d) { return d; })
            .attr("text-anchor", "start")
            .attr("font-size", 8)
            .attr("dy", 0)
            .call(wrap, xDim.bandwidth());

        function plotHop(hop) {

            var row = g.append("g").classed("row", 1);
            var row_n = d3.selectAll(".row").size() - 1;
            row.attr("transform", "translate(0," + rowHeight * row_n + ")")
            row.append("g")
                .attr("transform", "translate(-10, 0)")
                .call(yAxis);

            row.append("text")
                .text(hop.toUpperCase())
                .attr("x", -margin.left)
                .attr("y", rowHeight / 2 + 8)
                .attr("text-anchor", "start")
                .attr("dy", 0)
                .call(wrap, margin.left/1.5);

            d3.json("hop_data/" + hop + ".json", function(data) {

                var dimBoxes = row.selectAll(".dimBox")
                    .data(data)
                    .enter()
                    .append("g")
                    .classed("dimbox", 1)
                    .attr("transform", function(d) {
                        return "translate(" + xDim(d.dimension) + ",0)";
                    });

                dimBoxes.selectAll(".senseData")
                    .data(function(d) {
                        return senses.map(function(s) {
                            return {
                                sense: s,
                                values: d[s]
                            };
                        })
                    })
                    .enter()
                    .append("g")
                    .attr("class", function(d) {
                        return "senseData " + d.sense + "Data";
                    })
                    .attr("transform", function(d) {
                        return "translate(" + xSense(d.sense) + ",0)";
                    });

                var senseGroups = dimBoxes.selectAll(".senseData");

                senseGroups.selectAll(".meanBar")
                    .data(function(d) {
                        return [d3.mean(d.values)];
                    })
                    .enter()
                    .append("rect")
                    .classed("meanBar", 1)
                    // .attr("y", function(d) {
                    //     return y(d) - barHeight/2;
                    // })
                    .attr("y", function(d) {return y(d)})
                    .attr("x", -barWidth / 2)
                    .attr("width", barWidth)
                    // .attr("height", barHeight)
                    .attr("height", function(d) { return y(0)-y(d)})
                    .on("mouseover", function(d) {
                        tooltip.html(d3.format("0.2f")(d))
                        .style("opacity", 1.0)
                        .style("left", (d3.event.pageX+10) + "px")
                        .style("top", (d3.event.pageY) + "px");
                    })
                    .on("mouseout", function() {tooltip.style("opacity", 0);});
                senseGroups.selectAll(".dataPoint")
                    .data(function(d) {
                        return d.values;
                    })
                    .enter()
                    .append("circle")
                    .classed("dataPoint", 1)
                    .attr("r", dataRadius)
                    .attr("fill", "black")
                    // .attr("cx", 0)
                    .attr("cy", function(d) {
                        return y(d);
                    })
                    .attr("fill-opacity", 0.1);


            })
        }

        var tooltip = d3.select("body").append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);
        plotHop("mosaic");
        plotHop("cascade");
        plotHop("huell-melon");


        /////////////////////////////////////////////////////////
        /////////////////// Helper Function /////////////////////
        /////////////////////////////////////////////////////////

        //Taken from http://bl.ocks.org/mbostock/7555321
        //Wraps SVG text
        function wrap(text, width) {
          text.each(function() {
          var text = d3.select(this),
            words = text.text().split(/[\s\-]/).reverse(),
            word,
            line = [],
            lineNumber = 0,
            lineHeight = 1.4, // ems
            y = text.attr("y"),
            x = text.attr("x"),
            dy = parseFloat(text.attr("dy")),
            tspan = text.text(null).append("tspan").attr("x", x).attr("y", y).attr("dy", dy + "em");

          while (word = words.pop()) {
            line.push(word);
            tspan.text(line.join(" "));
            if (tspan.node().getComputedTextLength() > width) {
            line.pop();
            tspan.text(line.join(" "));
            line = [word];
            tspan = text.append("tspan").attr("x", x).attr("y", y).attr("dy", ++lineNumber * lineHeight + dy + "em").text(word);
            }
          }
          });
        }//wrap
    </script>


</body>

</html>
